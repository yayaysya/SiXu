name: Build and Release

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, master ]  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶æ„å»º
  release:
    types: [ published ]         # å‘å¸ƒReleaseæ—¶ä¸Šä¼ æ–‡ä»¶
  workflow_dispatch:             # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  # æ„å»ºä»»åŠ¡
  build:
    runs-on: ubuntu-latest
    name: Build Plugin

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºç‰ˆæœ¬ç®¡ç†

      # 2. è®¾ç½®Node.jsç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'  # å¯ç”¨npmç¼“å­˜åŠ é€Ÿæ„å»º

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # 4. ç‰ˆæœ¬éªŒè¯
      - name: Version validation
        run: |
          if [ ! -f "manifest.json" ]; then
            echo "âŒ manifest.json not found"
            exit 1
          fi
          version=$(jq -r '.version' manifest.json)
          if [ "$version" = "null" ] || [ -z "$version" ]; then
            echo "âŒ Invalid version in manifest.json"
            exit 1
          fi
          echo "ğŸ“¦ Building version: $version"
          echo "PLUGIN_VERSION=$version" >> $GITHUB_ENV

      # 5. TypeScriptæ£€æŸ¥å’Œæ„å»º
      - name: Type checking and build
        run: |
          echo "ğŸ” Running TypeScript check..."
          npm run build
          echo "âœ… TypeScript check passed"

          echo "ğŸ—ï¸ Building ZIP package..."
          npm run build:zip
          echo "âœ… ZIP package created"

      # 6. éªŒè¯æ„å»ºäº§ç‰©
      - name: Verify build artifacts
        run: |
          echo "ğŸ“‹ Verifying build artifacts..."

          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
          required_files=("main.js" "manifest.json" "styles.css")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file missing: $file"
              exit 1
            fi
            echo "âœ… Found: $file"
          done

          # æ£€æŸ¥ZIPæ–‡ä»¶
          zip_files=$(ls *.zip 2>/dev/null | wc -l)
          if [ "$zip_files" -eq 0 ]; then
            echo "âŒ No ZIP file found"
            exit 1
          fi

          # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
          echo "ğŸ“¦ Generated files:"
          ls -la *.zip *.js *.json *.css 2>/dev/null || true

      # 7. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sixu
          path: |
            *.zip
            main.js
            manifest.json
            styles.css
          retention-days: 30  # ä¿ç•™30å¤©
          if-no-files-found: error

      # 8. æ„å»ºæ‘˜è¦
      - name: Build Summary
        run: |
          echo "## ğŸ‰ æ„å»ºå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ env.PLUGIN_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          ls -la *.zip *.js *.json *.css 2>/dev/null | while read line; do
            echo "- $line" >> $GITHUB_STEP_SUMMARY
          done

  # Releaseå‘å¸ƒä»»åŠ¡
  release:
    needs: build
    runs-on: ubuntu-latest
    name: Release Plugin
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
      # 1. ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: sixu
          path: ./release-files

      # 2. éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
      - name: Verify downloaded files
        run: |
          cd release-files
          echo "ğŸ“‹ Downloaded files:"
          ls -la

          zip_files=$(ls *.zip 2>/dev/null | wc -l)
          if [ "$zip_files" -eq 0 ]; then
            echo "âŒ No ZIP file found in artifacts"
            exit 1
          fi

          echo "âœ… Found $zip_files ZIP file(s)"

      # 3. ä¸Šä¼ åˆ°Release
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-files/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4. Releaseæ‘˜è¦
      - name: Release Summary
        run: |
          echo "## ğŸš€ Release å‘å¸ƒå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Release ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åç§°**: ${{ github.event.release.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ å‘å¸ƒæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          cd release-files
          ls -la *.zip | while read line; do
            size=$(echo $line | awk '{print $5}')
            file=$(echo $line | awk '{print $9}')
            echo "- **$file**: $(numfmt --to=iec-i --suffix=B $size)" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¥ å®‰è£…è¯´æ˜" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ZIPæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "2. åœ¨Obsidianä¸­å¯ç”¨ç¬¬ä¸‰æ–¹æ’ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "3. å°†ZIPæ–‡ä»¶è§£å‹åˆ°æ’ä»¶ç›®å½•" >> $GITHUB_STEP_SUMMARY
          echo "4. åœ¨è®¾ç½®ä¸­å¯ç”¨'æ€åº'æ’ä»¶" >> $GITHUB_STEP_SUMMARY

  # é€šçŸ¥ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
  notify:
    needs: [build, release]
    runs-on: ubuntu-latest
    name: Build Status
    if: always()

    steps:
      - name: Build Status Notification
        run: |
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "âœ… æ„å»ºæˆåŠŸå®Œæˆ"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
            exit 1
          fi

          if [ "${{ github.event_name }}" = "release" ] && [ "${{ github.event.action }}" = "published" ]; then
            if [ "${{ needs.release.result }}" = "success" ]; then
              echo "ğŸ‰ Release ${{ github.event.release.tag_name }} å‘å¸ƒæˆåŠŸ!"
            else
              echo "âŒ Release å‘å¸ƒå¤±è´¥"
              exit 1
            fi
          fi